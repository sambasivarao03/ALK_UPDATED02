package com.alk.service.handler;

import com.alk.dto.*;
import com.alk.dto.datasource.*;
import com.alk.model.*;
import com.alk.repository.*;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

@Component
public class UpdateHandler implements ActionHandler {

    private final PiiRepository piiRepository;
    private final PiiHandler piiHandler;

    private final AadhaarDataRepository aadhaarRepo;
    private final PanDataRepository panRepo;
    private final VoterDataRepository voterRepo;
    private final DrivingLicenseRepository dlRepo;

    public UpdateHandler(
            PiiRepository piiRepository,
            PiiHandler piiHandler,
            AadhaarDataRepository aadhaarRepo,
            PanDataRepository panRepo,
            VoterDataRepository voterRepo,
            DrivingLicenseRepository dlRepo
    ) {
        this.piiRepository = piiRepository;
        this.piiHandler = piiHandler;
        this.aadhaarRepo = aadhaarRepo;
        this.panRepo = panRepo;
        this.voterRepo = voterRepo;
        this.dlRepo = dlRepo;
    }

    @Override
    public String getActionName() {
        return "UPDATE";
    }

    @Override
    @Transactional
    public PiiResponseDto handle(ManageRequestDto request) {

        String source = request.getSource().toUpperCase();

        // 1Ô∏è‚É£ Get OLD alk from request
        String oldAlk = request.getOldAlk();
        if (oldAlk == null)
            throw new RuntimeException("oldAlk is required for UPDATE");

        // 2Ô∏è‚É£ Fetch old PII
        Pii oldPii = piiRepository.findByAlk(oldAlk)
                .orElseThrow(() -> new RuntimeException("Old PII not found for ALK: " + oldAlk));

        // 3Ô∏è‚É£ Extract new person details
        CommonPersonDto person = switch (source) {
            case "AADHAAR" -> request.getAadhaar().getPerson();
            case "PAN" -> request.getPan().getPerson();
            case "VOTER" -> request.getVoter().getPerson();
            case "DRIVING" -> request.getDriving().getPerson();
            default -> throw new RuntimeException("Unknown source: " + source);
        };

        // 4Ô∏è‚É£ Compute new piiPk
        String newPiiPk = PiiPkGenerator.compute(
                person.getForename(),
                person.getLastName(),
                person.getDob().toString(),
                person.getGender()
        );

        // 5Ô∏è‚É£ Create brand new PII identity with new ALK
        Pii newPii = piiHandler.createNew(newPiiPk);

        // 6Ô∏è‚É£ Insert NEW source-specific data
        switch (source) {
            case "AADHAAR" -> insertAadhaar(request.getAadhaar(), newPii);
            case "PAN"     -> insertPan(request.getPan(), newPii);
            case "VOTER"   -> insertVoter(request.getVoter(), newPii);
            case "DRIVING" -> insertDriving(request.getDriving(), newPii);
        }

        // 7Ô∏è‚É£ Increment NEW PII counter
        piiHandler.increment(newPii, source);

        // 8Ô∏è‚É£ Decrement OLD PII counter
        piiHandler.decrement(oldPii, source);

        // 9Ô∏è‚É£ Delete old PII if empty
        if (piiHandler.shouldDelete(oldPii)) {
            piiRepository.delete(oldPii);
        }

        // üîü Return new ALK & old record status
        PiiResponseDto response = piiHandler.toResponse(newPii);
        response.setMessage(
                "New record created. Old record " +
                        (piiHandler.shouldDelete(oldPii) ? "deleted" : "updated with decremented counter.")
        );

        return response;
    }

    private void insertAadhaar(AadhaarRequestDto dto, Pii pii) {
        AadhaarData d = new AadhaarData();
        d.setAadhaarNumber(dto.getAadhaarNumber());
        d.setForename(dto.getPerson().getForename());
        d.setMiddleName(dto.getPerson().getMiddleName());
        d.setLastName(dto.getPerson().getLastName());
        d.setDob(dto.getPerson().getDob());
        d.setGender(dto.getPerson().getGender());
        d.setAddress(dto.getPerson().getAddress());
        d.setParentGuardianName(dto.getParentGuardianName());
        d.setMobileNumber(dto.getMobile());
        d.setEmail(dto.getEmail());
        d.setPii(pii);
        aadhaarRepo.save(d);
    }

    private void insertPan(PanRequestDto dto, Pii pii) {
        PanData d = new PanData();
        d.setPanNumber(dto.getPanNumber());
        d.setForename(dto.getPerson().getForename());
        d.setMiddleName(dto.getPerson().getMiddleName());
        d.setLastName(dto.getPerson().getLastName());
        d.setFatherName(dto.getFatherName());
        d.setMotherName(dto.getMotherName());
        d.setDateOfBirth(dto.getPerson().getDob());
        d.setGender(dto.getPerson().getGender());
        d.setAddress(dto.getPerson().getAddress());
        d.setPhone(dto.getPhone());
        d.setEmail(dto.getEmail());
        d.setAadhaarNumberLinked(dto.getAadhaarLinked());
        d.setPii(pii);
        panRepo.save(d);
    }

    private void insertVoter(VoterRequestDto dto, Pii pii) {
        VoterData d = new VoterData();
        d.setEpicNumber(dto.getEpicNumber());
        d.setForename(dto.getPerson().getForename());
        d.setMiddleName(dto.getPerson().getMiddleName());
        d.setLastName(dto.getPerson().getLastName());
        d.setDob(dto.getPerson().getDob());
        d.setAddress(dto.getPerson().getAddress());
        d.setRelativeName(dto.getRelativeName());
        d.setPhotograph(dto.getPhotograph());
        d.setAssemblyConstituency(dto.getAssemblyConstituency());
        d.setElectoralDistrict(dto.getElectoralDistrict());
        d.setPartNumber(dto.getPartNumber());
        d.setPii(pii);
        voterRepo.save(d);
    }

    private void insertDriving(DrivingLicenseRequestDto dto, Pii pii) {
        DrivingLicense d = new DrivingLicense();
        d.setDlNumber(dto.getDlNumber());
        d.setForename(dto.getPerson().getForename());
        d.setMiddleName(dto.getPerson().getMiddleName());
        d.setLastName(dto.getPerson().getLastName());
        d.setDob(dto.getPerson().getDob());
        d.setAddress(dto.getPerson().getAddress());
        d.setLicenseClass(dto.getLicenseClass());
        d.setHeight(dto.getHeight());
        d.setBloodType(dto.getBloodType());
        d.setIssueDate(dto.getIssueDate());
        d.setExpiryDate(dto.getExpiryDate());
        d.setGender(dto.getPerson().getGender());
        d.setPii(pii);
        dlRepo.save(d);
    }
}
